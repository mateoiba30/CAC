;9A, HAY INT, HAY PIC, NO CHEQUEO BUSY NI STROBE
HAND EQU 40H;DATOS ESTADO
PIC EQU 20H; EOI IMR IRR ISR INT0 INT1 INT2(HAND) INT3
N_HND EQU 10

ORG 40
IP_HND DW RUT_HND

ORG 1000H
CARS DB "?????"
FIN DB ?

ORG 3000H

;NO PUSHEO PARA NO PERDER EL PROGRESO
RUT_HND:CMP DH,0
JNZ REVERSA

MOV AL,[BX]
OUT HAND,AL
INC BX
DEC CL

CMP CL,0
JNZ FIN2
NOT DH;CAMBIO DE SENTIDO
MOV CL, OFFSET FIN - OFFSET CARS
DEC BX;BX APUNTA AL ULTIMO CAR
JMP FIN2

REVERSA:MOV AL,[BX]
OUT HAND,AL
DEC BX
DEC CL

FIN2:MOV AL,20H;FIN
OUT PIC,AL
IRET

HAB_INT:PUSH AX
IN AL, HAND+1
OR AL,10000000B
OUT HAND+1,AL
POP AX
RET

DESHAB_INT:PUSH AX
IN AL, HAND+1
AND AL,01111111B
OUT HAND+1,AL
POP AX
RET

CONF_PIC:PUSH AX
MOV AL,11111011B
OUT PIC+1,AL;ENMASCARO TODO MENOS LA INT2 EN EL IMR
MOV AL,N_HND
OUT PIC+6,AL;MANDO RUTINA PARA LA INT2
POP AX
RET

LEER_CARS:PUSH BX
PUSH CX
REP:INT 6
INC BX
DEC CL
JNZ REP
POP CX
POP BX
RET

ORG 2000H
CLI
MOV DH,0;DH INDICA SENTIDO DE CARGA
MOV BX, OFFSET CARS
MOV CL, OFFSET FIN - OFFSET CARS
CALL HAB_INT
CALL CONF_PIC
CALL LEER_CARS
STI

ESPERAR: CMP CL,0H
JNZ ESPERAR

CALL DESHAB_INT;NO REALMENTE NECESARIO

INT 0
END